rm(list=ls())
library(plotly)
load("clusters.Rda")
if (!require("pacman")) install.packages("pacman"); library(pacman)
p_load_gh('hrbrmstr/pluralize')
p_load(quanteda)

df <- read.csv(file='datas/RAW_recipes.csv',sep=",",colClasses = c(NA,NA,"NULL","NULL","NULL","NULL",NA,"NULL","NULL","NULL",NA,"NULL"))
reviews <- read.csv(file ='datas/RAW_interactions.csv',sep=",",colClasses = c("NULL",NA,"NULL",NA,"NULL"))
reviews <- aggregate(reviews[2],reviews[1],mean)
recipes <- merge(df,reviews,by.x = "id",by.y = "recipe_id")

exploitable <- merge(clusterized,recipes,by.x="id",by.y="id")

#Top ingredients list
#====================
preprocess_ingredient <-function(ingredients){
  for(i in 1:length(ingredients)){
    processed <- singularize(unlist(tokenize(ingredients[i])))
  }
}

get_top_ingredients <- function(data,cluster){
  ingredient_list <- data.frame(ingredient=c())
  
  for (i in 1:nrow(exploitable)){
    if(exploitable[i,"cluster"]==cluster){
      ingredients <- exploitable[i,"ingredients"]
      ingredients <- sub("\\[","",ingredients[1])
      ingredients <- sub("\\]","",ingredients)
      ingredients <- strsplit(ingredients,",")
      ingredient_list <- rbind(ingredient_list, ingredients)
    }
  }
  
  ing_count <- aggregate(ingredient_list,by=ingredient_list,FUN=length)
  colnames(ing_count) <- c("ingredient","count")
  ing_count <- ing_count[order(-ing_count$count),]
  return(head(ing_count,25))
}

listed_1 <- get_top_ingredients(exploitable,1)
listed_2 <- get_top_ingredients(exploitable,2)
listed_3 <- get_top_ingredients(exploitable,3)
listed_4 <- get_top_ingredients(exploitable,4)
listed_5 <- get_top_ingredients(exploitable,5)
listed_6 <- get_top_ingredients(exploitable,6)

listed_1$ingredient <- factor(listed_1$ingredient, levels = c(as.character(listed_1$ingredient)))
listed_2$ingredient <- factor(listed_2$ingredient, levels = c(as.character(listed_2$ingredient)))
listed_3$ingredient <- factor(listed_3$ingredient, levels = c(as.character(listed_3$ingredient)))
listed_4$ingredient <- factor(listed_4$ingredient, levels = c(as.character(listed_4$ingredient)))
listed_5$ingredient <- factor(listed_5$ingredient, levels = c(as.character(listed_5$ingredient)))
listed_6$ingredient <- factor(listed_6$ingredient, levels = c(as.character(listed_6$ingredient)))

fig <- plot_ly(listed_1, x=~ingredient, y=~count, name = "4th cluster's top ingredients", type = "bar")
fig
htmlwidgets::saveWidget(as_widget(fig), "top_ingredients_1.html")

#Review distributions
#====================
notations <- exploitable
notations$cluster <- as.character(notations$cluster)

fig <- plot_ly(notations,y = ~rating, color=~cluster, colors=c("#A846DD","#4357AD","#00A6A6","#DB5461","#FFD97D","#36382E"), type = "box")
fig <- fig %>% layout(title = 'Review scores distribution by cluster')
fig
htmlwidgets::saveWidget(as_widget(fig), "reviews.html")

#Average calorie intake
#======================
get_calories <- function(nutrition){
  nutrition <- sub("\\[","",nutrition[1])
  nutrition <- sub("\\]","",nutrition)
  nutrition <- unlist(strsplit(nutrition,","))
  return(nutrition[1])
}

calories <- exploitable
calories[,"nutrition"] <- sapply(calories[,"nutrition"],get_calories)
calories$cluster <- as.character(calories$cluster)

fig <- plot_ly(calories,y=~nutrition, color=~cluster, type = "box", colors=c("#A846DD","#4357AD","#00A6A6","#DB5461","#FFD97D","#36382E"))
fig <- fig %>% layout(title = 'Calorie intake distribution by cluster')
fig
htmlwidgets::saveWidget(as_widget(fig), "calories.html")
